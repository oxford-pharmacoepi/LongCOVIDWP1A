---
title: "Descriptive characteristics of Long COVID Cohorts"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      warning=FALSE, 
                      message=FALSE, 
                      comment = FALSE,
                      cache = FALSE,
                      cache.lazy=FALSE)
options(scipen=999)

```


```{r include=FALSE}
# packages
library(SqlRender)
library(DBI)
library(DatabaseConnector)
library(here)
library(dplyr)
library(tidyr)
library(CDMConnector)
library(stringr)
library(lubridate)
library(gtsummary)
library(tableone)
library(kableExtra)
library(ggplot2)
library(forcats)

# Connection details ----
server    <- Sys.getenv("SERVER_JUN22")
server_dbi<- Sys.getenv("SERVER_DBI_JUN22")
user      <- Sys.getenv("DB_USER_JUN22")
password  <- Sys.getenv("DB_PASSWORD_JUN22")
port      <- Sys.getenv("DB_PORT_JUN22") 
host      <- Sys.getenv("DB_HOST_JUN22") 


db <- dbConnect(RPostgres::Postgres(), 
                dbname = server_dbi,
                port = port,
                host = host, 
                user = user, 
                password = password)

targetDialect              <- "postgresql"
cdm_database_schema        <- "omop21t4_cmbd" 
vocabulary_database_schema <-"omop21t4_cmbd" 
write_schema               <-"results21t4_cmbd"

# Generate cdm object to access the tables
cdm <- cdm_from_con(db, 
             cdm_schema = cdm_database_schema,
             write_schema = write_schema,
             cohort_tables = c("er_long_covid_final_cohorts",
                               "er_long_covid_all_symptoms_cohorts"))

#  get ids for cohorts

cohorts_ids  <- read.csv2(here("ATLAS Cohort Definitions_LongCovid.csv")) %>%
                          mutate(name= paste(sub(".*LongCov-ER_", "", name)))

new_infection_id <- as.character(cohorts_ids %>%
                    filter(str_detect(name, "New_Infection")) %>% 
                    select(cohort_definition_id) %>% pull())

tested_positive_id <- as.character(cohorts_ids %>%
                    filter(str_detect(name, "Tested_Positive")) %>% 
                    select(cohort_definition_id) %>% pull())

tested_negative_earliest_id <- as.character(cohorts_ids %>%
                    filter(str_detect(name, "Tested_Negative_earliest")) %>% 
                    select(cohort_definition_id) %>% pull())

pcr_negative_earliest_id <-as.character( cohorts_ids %>%
                    filter(str_detect(name, "PCR_Negative_earliest")) %>% 
                    select(cohort_definition_id) %>% pull())

tested_negative_all_id <- as.character(cohorts_ids %>%
                    filter(str_detect(name, "Tested_Negative_all")) %>% 
                    select(cohort_definition_id) %>% pull())

pcr_negative_all_id <-as.character( cohorts_ids %>%
                    filter(str_detect(name, "PCR_Negative_all")) %>% 
                    select(cohort_definition_id) %>% pull())

# get data for table 1
load(here("data", "table1_data.Rdata"))

```



```{r include=FALSE}
table1.data<-rbind(  
# those without missing values
       table1_data_new_infections   %>%
        mutate(group = "COVID-19_infection"),
        table1_data_new_infections  %>%
        filter(long_covid == 1)%>%
          mutate(group = "Long Covid symptoms (90 days)"))


# variables
vars<-c(
        "age",
        "age_gr2",
        "gender",
        "trimester",
        "nationality_cat",
        "vaccination_status",
        "medea",
        "asthma",
        "autoimmune_disease",
        "copd",
        "dementia",
        "diabetes",
        "heart_disease",
        "cancer",
        "hypertension",
        "renal_impairment"
)

factor.vars<- c(
        "age_gr2",
        "gender",
                "trimester",
        "nationality_cat",
        "vaccination_status",
        "medea",
        "asthma",
        "autoimmune_disease",
        "copd",
        "dementia",
        "diabetes",
        "heart_disease",
        "cancer",
        "hypertension",
        "renal_impairment"
)



summary.characteristics <-print(CreateTableOne(
  vars =  vars,
  factorVars = factor.vars,
  includeNA=T,
  data = table1.data,
  strata=c("group"),
  test = F), 
  showAllLevels=F,
  smd=T,
  nonnormal = vars, #all 
  noSpaces = TRUE,
  contDigits = 1,
  printToggle=FALSE)

 
```


## Table: Baseline characteristics of individuals with COVID-19 and with long COVID-19 
```{r echo=FALSE}

kable(summary.characteristics, 
      col.names = c("COVID-19 infection",  
                    "Long COVID-19, 90 days",
                    "SMD"
                    ))%>%
  kable_styling(bootstrap_options = c("striped", "bordered")) #%>%
 # pack_rows("Baseline comorbidities", 40, 44)


```




```{r include=FALSE}
table2.data<-rbind(  
# those without missing values
       table1_data_tested_negative   %>%
        mutate(group = "1- Tested negative"),
       table1_data_tested_negative   %>%
        filter(long_covid == 1)%>%
          mutate(group = "2- Long Covid symptoms (90 days)"))


summary.characteristics.negative <-print(CreateTableOne(
  vars =  vars,
  factorVars = factor.vars,
  includeNA=T,
  data = table2.data,
  strata=c("group"),
  test = F), 
  showAllLevels=F,
  smd=T,
  nonnormal = vars, #all 
  noSpaces = TRUE,
  contDigits = 1,
  printToggle=FALSE)


 
```


## Table: Baseline characteristics of individuals tested negative and with long COVID-19 symptoms
```{r}

kable(summary.characteristics.negative, 
      col.names = c("Tested negative, earliest",  
                    "Long COVID-19 symptoms, 90 days",
                    "SMD"
                    ))%>%
  kable_styling(bootstrap_options = c("striped", "bordered")) #%>%
 # pack_rows("Baseline comorbidities", 40, 44)


```



```{r include=FALSE}
table3.data<-rbind(  
# those without missing values
        table1_data_new_infections  %>%
        mutate(group = "New infections"),
        table1_data_tested_negative   %>%
        mutate(group = "Tested negative"),
        table1_data_tested_negative_all   %>%
        mutate(group = "Tested negative, all")
        )



summary.characteristics.infection.negative <-print(CreateTableOne(
  vars =  vars,
  factorVars = factor.vars,
  includeNA=T,
  data = table3.data,
  strata=c("group"),
  test = F), 
  showAllLevels=F,
  smd=T,
  nonnormal = vars, #all 
  noSpaces = TRUE,
  contDigits = 1,
  printToggle=FALSE)


 
```


## Table: Baseline characteristics of individuals with new COVID-19 infection and Tested negative (earliest)
```{r echo=FALSE}

kable(summary.characteristics.infection.negative, 
      col.names = c("COVID-19 infection",  
                    "Tested negative, earliest",
                    "Tested negative, all events",
                    "SMD"
                    ))%>%
  kable_styling(bootstrap_options = c("striped", "bordered")) #%>%
 # pack_rows("Baseline comorbidities", 40, 44)


```





```{r include=FALSE}
# function to obtain data for table
generate_table <- function(cohort_id, window, name){
data <- cdm$er_long_covid_all_symptoms_cohorts %>%
  filter(main_cohort_id == cohort_id & window_days == window) %>%
  distinct() %>%
  collect()
summary <-  data%>% 
  mutate(all_symp = as.factor(all_symp)) %>%
  select(-subject_id, -window_days, - main_cohort_id, - cohort_start_date ) %>%
  mutate(gen = paste0(name)) %>%
   tbl_summary(
       by = "gen",
  digits = all_categorical()~ c(0,1),
  missing = "ifany",
  missing_text= "Missing",
  percent = "col"
           ) %>% 
  bold_labels()

  summary
}
```



```{r include=FALSE}
t.covid.infection <- generate_table(cohort_id= new_infection_id,
                                    window="90",
                                    name = "COVID-19 infection")

t.covid.confirmed <- generate_table(cohort_id= tested_positive_id,
                                    window="90",
                                    name = "Laboratory-confirmed infections")

t.covid.reinfections <- generate_table(cohort_id= "71",
                                    window="90",
                                    name = "Reinfections")

t.tested.negative.earliest <- generate_table(cohort_id = tested_negative_earliest_id,
                                    window="90",
                                    name = "Tested negative, earliest")


t.tested.negative.all <- generate_table(cohort_id = tested_negative_all_id,
                                    window="90",
                                    name = "Tested negative, all")


t.pcr.negative.earliest <- generate_table(cohort_id = pcr_negative_earliest_id,
                                    window="90",
                                    name = "PCR negative, earliest")
t.pcr.negative.all <- generate_table(cohort_id = pcr_negative_all_id,
                                    window="90",
                                    name = "PCR negative, all")

```


## Table: Symptom distribution across cohorts
```{r echo=FALSE}
table  <- tbl_merge(tbls = list(t.covid.infection,   
                                t.covid.confirmed,
                                t.covid.reinfections,
                                t.tested.negative.earliest,
                                 t.tested.negative.all,
                                t.pcr.negative.earliest,
                                 t.pcr.negative.all
                                 ), 
                     tab_spanner = c("","", "", "", "", "", ""))

table

```

## Figure: Heatmap of symptoms distribution across cohorts
```{r include=FALSE}
get_prop <- function(data){
  filt <- c("1","2","3","4","5","6","7","8","9","10","11", "__all_symp__")
  output <- as_tibble(data,  col_labels = FALSE) %>%
  filter(!(label %in% filt)) %>%
 mutate(prop = str_extract(stat_1, "(?<=\\()(.*?)%")) %>%
  mutate(prop= substring(prop,1, nchar(prop)-1)) %>%
  mutate(prop = as.numeric(prop)) %>%
  select(-stat_1) %>%
  mutate(label= substring(label,1, nchar(label)-2)) %>%
  mutate(label= substring(label,3)) %>%
  as.data.frame()
} 

results <- rbind(
  get_prop(t.covid.infection) %>%  mutate(group = "COVID-19\n infection"),
  get_prop(t.covid.confirmed) %>%  mutate(group = "Laboratory-confirmed\nCOVID-19 infections"),
  get_prop(t.covid.reinfections) %>% mutate(group = "Reinfections"),
  get_prop(t.tested.negative.earliest) %>% mutate(group = "Tested negative,\n earliest"),
  get_prop( t.tested.negative.all) %>% mutate(group = "Tested negative ,\n all"),
  get_prop( t.pcr.negative.earliest) %>% mutate(group = "Tested negative (PCR only),\n earliest"),
  get_prop( t.pcr.negative.all) %>% mutate(group = "Tested negative (PCR only),\n all")
 ) %>%
  mutate(label = str_replace_all(label, "_", " ")) %>%
  mutate(label = str_to_title(label)) 

```

```{r echo=FALSE}
results %>% 
    mutate(label = fct_rev(factor(label))) %>%
  ggplot() +
  aes(x = 1, y = label, fill = prop) +
  facet_grid(~group)+
  geom_tile(colour = "black") +
  scale_fill_gradient(high = "#C81D25", low = "#E4F1EB")+
  geom_text(aes(label = round(prop, 1))) +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        legend.position = "bottom")+
  xlab("")+
  ylab("Symptom")+
  labs(fill= "Proportion, in %")


```




