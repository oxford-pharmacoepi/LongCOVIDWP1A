---
  title: "Long COVID characterisation tables, CPRD"
date: '2022-12-01'
output: 
  html_document:
  toc: true
toc_depth: 3

---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# packages
library(dplyr)
library(ggplot2)
library(kableExtra)
library(stringr)
```

```{r include=FALSE}
# load results
# Table 1 results
folder <- "CPRD_results/"
database_name <- "_CPRD"
files <-list.files(path= folder, pattern="*.csv")
files <- str_remove(files, "_CPRD.csv")
#files <- paste0(folder, "/", files)

for (i in 1:length(files)){
  assign(files[i], read.csv(paste0(folder, files[i], database_name, ".csv"), header = TRUE, sep = ";"))
} 
# RR
folder <- "CPRD_results/RR/"
files <-list.files(path= folder, pattern="*.csv")
files <- str_remove(files, "_CPRD.csv")
#files <- paste0(folder, "/", files)

for (i in 1:length(files)){
  assign(files[i], read.csv2(paste0(folder, files[i], database_name, ".csv"), header = TRUE, sep = ";", stringsAsFactors=FALSE))
} 

```


```{r include=FALSE}
# theme and function for ggplot
mytheme <-  theme_bw() +
  theme(
    #   text = element_text(family = "A"),
    panel.spacing = unit(1, "lines"),
    panel.border = element_blank(),
    legend.position = "top",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    axis.ticks.x =element_line(),
    axis.ticks.y =element_blank(),
    strip.text.y.left = element_text(size = 14, face = "bold", angle = 0),
    strip.text.x = element_text(size = 14, face = "bold"),
    strip.background = element_blank(),
    #  panel.grid.major.y = element_blank() , # remove horizontal lines
    # top, rigth, bottom.left
    plot.margin = unit(c(0,0,1,0), "lines")
  )

get_plot <- function(data) {
  gg.plot <- data  %>%
    ggplot(aes(
      x = relative_risk,
      y = reorder(symptom, relative_risk),
      xmin = low_ci,
      xmax = up_ci,
      color = database)) +
    geom_point(size = 2, position = position_dodge(width = 1)) +
    geom_errorbar(width = 0, size = 1, position = position_dodge(width = 1)) +
    scale_y_discrete(expand=c(0,0), position = "left") +
    scale_x_log10() +
    geom_vline(
      xintercept = 1, colour = "#000000",
      linetype = 1
    ) +
    mytheme +
    xlab("\nRR (with 95% CI)") +
    ylab("")  +
    guides(color = guide_legend(title = ""))
  
  gg.plot
}


```

# Flowchart

![Study flowchart](flowchart_longcov.png)


## >90 days symptoms  {.tabset}
### Tables
#### Table 1: Baseline characteristics and symptoms recorded

```{r echo=FALSE}
kable(Table1_90days,
      col.names = c("", "COVID-19\ninfection",
                    "First\ninfection", "Reinfections",
                    "Tested negative,\nall", 
                    "Tested negative,\nearliest")) %>%  
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                fixed_thead = T
  ) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 


```

#### Table 2: Baseline characteristics and symptoms distribution among COVID-19 infections vs Tested negative, earliest (after matching 1:3 by age group, week of testing and antigen/PCR test)

```{r echo=FALSE}
kable(Table_Matched_Infection_Tested_Negative_earliest_90days,
      col.names = c("", "COVID-19\ninfection", "Tested negative,\nearliest", "SMD")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F,
                fixed_thead = T) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 


```

#### Table 3: Baseline characteristics and symptoms distribution among COVID-19 infections vs Tested negative, all records (after matching 1:3 by age group, week of testing and antigen/PCR test)
```{r}
kable(Table_Matched_Infection_Tested_Negative_all_90days,
      col.names = c("", "COVID-19\ninfection", "Tested negative,\nall", "SMD")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F,
                fixed_thead = T) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 

```

##### Table 4: Baseline characteristics and symptoms among people with a first COVID-19 infection vs Reinfection (after matching 1:6 by age group, week of testing and antigen/PCR test)

```{r echo=FALSE}
kable(Table_Matched_First_infection_Reinfections_90days,
      col.names = c("", "First infection", "Reinfection", "SMD")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F,
                fixed_thead = T) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 
```

### Relative risks
#### Figure 1: RR for each symptom, COVID-19 infections vs Tested negative
```{r, fig.dim= c(12,8), echo=FALSE}

rr_new_covid_tested_negative <- rbind(RR_new_covid_tested_negative_earliest_90days %>% mutate(records = "Earliest record"),
                                      RR_new_covid_tested_negative_all_90days %>% mutate(records = "All records"))



gg.rr.infec_negative <- get_plot(rr_new_covid_tested_negative)+ facet_grid(.~ records )
gg.rr.infec_negative

```

#### Figure 2: RR for each symptom, first infection vs reinfections
```{r, fig.dim = c(6, 6), echo = FALSE}
gg.rr.first_reinfection <- get_plot(RR_first_infection_reinfections_90days)
gg.rr.first_reinfection
```

## > 28 days symptoms  {.tabset}
### Tables
#### Table 1: Baseline characteristics and symptoms recorded

```{r echo=FALSE}
kable(Table1_28days,
      col.names = c("", "COVID-19\ninfection",
                    "First\ninfection",
                    "Reinfections",
                    "Tested negative,\nall",
                    "Tested negative,\nearliest")) %>%  
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                fixed_thead = T
  ) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 

```

#### Table 2: Baseline characteristics and symptoms distribution among COVID-19 infections vs Tested negative, earliest (after matching 1:1 by age group, week of testing and antigen/PCR test)

```{r echo=FALSE}
kable(Table_Matched_Infection_Tested_Negative_earliest_28days,
      col.names = c("", "COVID-19 infection", "Tested negative, earliest", "SMD")) %>%  
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F,
                fixed_thead = T) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 

```

#### Table 3: Baseline characteristics and symptoms among people with a first COVID-19 infection vs Reinfection (after matching 1:1 by age group, week of testing and antigen/PCR test)

```{r echo=FALSE}
kable(Table_Matched_First_infection_Reinfections_28days,
      col.names = c("", "First infection", "Reinfection", "SMD")) %>%  
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F,
                fixed_thead = T) %>%
  pack_rows("Comorbidities",12, 20) %>%
  row_spec(21, bold = T) %>%
  row_spec(47, bold = T) %>%
  pack_rows("Symptoms",22, 46) 
```

### Relative risks
#### Figure 1: RR for each symptom, COVID-19 infections vs Tested negative (earliest and all records)
```{r, fig.dim = c(12, 8), echo = FALSE}

rr_new_covid_tested_negative <- rbind(RR_new_covid_tested_negative_earliest_28days %>% mutate(records = "Earliest record"),
                                      RR_new_covid_tested_negative_all_28days %>% mutate(records = "All records"))



gg.rr.infec_negative <- get_plot(rr_new_covid_tested_negative)+ facet_grid(.~ records )
gg.rr.infec_negative

```

#### Figure 2: RR for each symptom, first infection vs reinfections
```{r, fig.dim = c(6, 6), echo = FALSE}
gg.rr.first_reinfection <- get_plot(RR_first_infection_reinfections_28days)
gg.rr.first_reinfection
```

